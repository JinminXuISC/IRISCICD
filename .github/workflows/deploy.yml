name: IRIS-CICD (DEV auto deploy)

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    # All IRIS configs are defined here (hardcoded)
    env:
      IRIS_INSTANCE: DEV
      IRIS_NAMESPACE: DEV
      IRIS_USER: superuser
      IRIS_PASS: sys

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build deploy.osc from template
        shell: powershell
        run: |
          # Path to template OSC file inside the checked-out repo
          $templatePath = Join-Path $env:GITHUB_WORKSPACE 'loadfile.osc'

          # Path to output OSC file in RUNNER_TEMP (always writable)
          $outputPath = Join-Path $env:RUNNER_TEMP 'deploy.osc'

          # Absolute path to /src folder
          $srcPath = Join-Path $env:GITHUB_WORKSPACE 'src'
          $srcPathEscaped = [regex]::Escape($srcPath)

          Write-Host "Reading template: $templatePath"
          $content = Get-Content $templatePath -Raw

          # Replace all placeholders
          $content = $content `
            -replace '\{USER\}', $env:IRIS_USER `
            -replace '\{PASS\}', $env:IRIS_PASS `
            -replace '\{NS\}',   $env:IRIS_NAMESPACE `
            -replace '\{SRC\}',  $srcPathEscaped

          Write-Host "Writing generated OSC file to: $outputPath"
          Set-Content -Path $outputPath -Value $content -Encoding ASCII -ErrorAction Stop

          # Export output path to next step
          "OSC_PATH=$outputPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding ASCII

      - name: Execute IRIS deployment
        shell: powershell
        run: |
          Write-Host "Executing IRIS terminal..."
          Write-Host "Using OSC: $env:OSC_PATH"
          iris terminal $env:IRIS_INSTANCE -U $env:IRIS_NAMESPACE < $env:OSC_PATH

          Write-Host "Deployment complete!"